import pytest
from bs4 import BeautifulSoup
from UniversalWebshopScraper.generalized_scrapper.core.generalized_scrapper import GeneralizedScraper


@pytest.fixture
def scraper():
    """
    Create an instance of the GeneralizedScraper class in offline mode for testing.
    """
    return GeneralizedScraper(offline_mode=True)


@pytest.mark.parametrize(
    "html_input, expected_price",
    [
        # Test case 1: Single block with a price
        (
            """<div><span>100</span><span>.99</span><span>$</span></div>""",
            "100.99$"
        ),
        # Test case 2: Noise text with price
        (
            """<div><span>Inteligentne zegarki Fitness Tracker IP 68, </span><span>100</span><span>$</span></div>""",
            "100$"
        ),
        # Test case 3: Complex price format
        (
            """<div><span>Special offer: </span><span>1,000</span><span>.50</span><span>USD</span></div>""",
            "1000.50USD"
        ),
        # Test case 4: No price present
        (
            """<div><span>No price available</span></div>""",
            None
        ),
        # Test case 5: Multiple prices, pick highest
        (
            """<div class="mqen_m6 mjyo_6x mgmw_3z mpof_ki mwdn_0 mp7g_oh mj7a_16 mg9e_16 mh36_16 mh36_24_l mvrt_16 mvrt_24_l m7er_k4 m0ux_vh mp5q_jr m31c_kb _1e32a_ENO3Q"><div class="mvrt_8 mse2_k4"><div><div class="mp7g_oh"><a href="https://allegro.pl/oferta/tv-led-32-hanseatic-32h450-dvb-t2-sat-hevc-usb-13855406841" rel="nofollow" aria-hidden="true" tabindex="-1" class="msts_9u mg9e_0 mvrt_0 mj7a_0 mh36_0 mpof_ki m389_6m mx4z_6m m7f5_6m _1e32a_7ZEQF"><img alt="TV LED 32&quot; Hanseatic 32H450 DVB-T2/SAT HEVC USB" loading="lazy" src="https://a.allegroimg.com/s180/1157b4/fa1b96654e41a84bc7528cc2c0d4/TV-LED-32-Hanseatic-32H450-DVB-T2-SAT-HEVC-USB" srcset="https://a.allegroimg.com/s180/1157b4/fa1b96654e41a84bc7528cc2c0d4/TV-LED-32-Hanseatic-32H450-DVB-T2-SAT-HEVC-USB 1x, https://a.allegroimg.com/s720/1157b4/fa1b96654e41a84bc7528cc2c0d4/TV-LED-32-Hanseatic-32H450-DVB-T2-SAT-HEVC-USB 2x"></a><div class="mpof_ki m389_6m mp7g_f6 mqm6_0 mj7u_0"><a data-analytics-interaction="true" data-analytics-interaction-label="energyLabel" class="mpof_ki"><img src="https://assets.allegrostatic.com/showoffer-icons-external/EFFICIENCY_CLASS_E.svg" alt="Etykieta energetyczna" class="m3h2_8 _1e32a_78N6o"></a></div></div></div></div><div class="mpof_ki mr3m_1 myre_zn myre_8v_l _1e32a_pAK3c"><div class="mjyo_6x mpof_ki myre_zn mj7a_8 mj7a_0_l mvrt_8_l m7er_k4 _1e32a_PH-oM"><div class="_1e32a_WGU9V mryx_16"><h2 class="mgn2_14 m9qz_yp mqu1_16 mp4t_0 m3h2_0 mryx_0 munh_0"><a href="https://allegro.pl/oferta/tv-led-32-hanseatic-32h450-dvb-t2-sat-hevc-usb-13855406841" class="mgn2_14 mp0t_0a mgmw_wo mj9z_5r mli8_k4 mqen_m6 l1qs9 l1jot meqh_en mpof_z0 mqu1_16 m6ax_n4 _1e32a_f18Kx ">TV LED 32" Hanseatic 32H450 DVB-T2/SAT HEVC USB</a></h2><div class="mg9e_4 mpof_ki myre_zn m389_5x"><div aria-label="4,81 na 5, 16 ocen produktu" role="group" class="mpof_vs mgn2_12 mqu1_g3 mgmw_3z"><span aria-hidden="true" class="m9qz_yq mgmw_wo">4,81</span><div aria-hidden="true" class="mpof_vs mjru_k4 mpof_vs mjru_k4 _1e32a_CoJOu m7er_80 mp4t_0 m3h2_4 mryx_0 munh_4 _1e32a_n4afv"><div class="mpof_vs mjru_k4 mpof_vs mjru_k4 _1e32a_CoJOu m7er_80 _1e32a_7GNWA" style="width: 96.2%;"></div></div><span aria-hidden="true" class="mpof_uk">(16)</span></div><div class="mpof_vs mgn2_12 mqu1_g3 mgmw_3z mg9e_2"><div class="mp7g_oh "><div class="mgn2_12 mpof_ki m389_6m mwdn_1"><div class="mpof_ki m389_6m mwdn_1 _1e32a_x7RE- m3h2_0"><span class="mli2_0" style="color: rgb(34, 34, 34); font-weight: bold; text-decoration: none;">22 osoby</span><span class="mli2_0" style="color: var(--m-color-text-secondary, #656565); font-weight: normal; text-decoration: none;">kupiły ostatnio</span></div></div><div class="mpof_5r mpof_3f_l mpof_3f"><div class="mjyo_6x mp7g_f6 mjb5_w6 msbw_2 mldj_2 mtag_2 mm2b_2 mgmw_wo msts_n6 m7er_k4 ti1554 ti1nw9 mpof_5r undefined"></div></div></div></div></div><div class="mpof_z0 m7er_k4 mg9e_4 mj7a_4"><div class="mgn2_12"><div><span class="mgmw_3z _1e32a_XFNn4">Smart TV</span> <span class="mgmw_wo mvrt_8 ">nie</span> <span class="mgmw_3z _1e32a_XFNn4">Liczba złączy HDMI</span> <span class="mgmw_wo mvrt_8 ">2</span> <span class="mgmw_3z _1e32a_XFNn4">Klasa efektywności energetycznej</span> <span class="mgmw_wo mvrt_8 ">E</span> <span class="mgmw_3z _1e32a_XFNn4">Szerokość produktu z podstawą</span> <span class="mgmw_wo mvrt_8 ">73.2 cm</span> <span class="mgmw_3z _1e32a_XFNn4">Wysokość produktu z podstawą</span> <span class="mgmw_wo mvrt_8 ">48.1 cm</span> <span class="mgmw_3z _1e32a_XFNn4">Głębokość produktu z podstawą</span> <span class="mgmw_wo mvrt_8 ">17.6 cm</span> </div></div></div><p class="mp4t_0 m3h2_0 mryx_0 munh_0 meqh_en m6ax_n4 mgn2_12 msa3_z4 _1e32a_3NbHx"><span>Produkt:</span> <a href="https://allegro.pl/produkt/tv-led-32-hanseatic-32h450-dvb-t2-sat-hevc-usb-3f6a6888-9b08-47e2-b303-f80dbcd1bbea" title="TV LED 32&quot; Hanseatic 32H450 DVB-T2/SAT HEVC USB" target="_self" class="mj9z_5r _1e32a_KBSWp">TV LED 32" Hanseatic 32H450 DVB-T2/SAT HEVC USB</a></p><div class="mpof_ki m389_6m "><a data-analytics-interaction="true" data-analytics-interaction-label="informationSheet" class="mgmw_3z msa3_z4 mj9z_5r mgn2_12"></a></div></div><div class="mp4t_56 mpof_ki myre_zn m389_5x"><a href="https://allegro.pl/produkt/tv-led-32-hanseatic-32h450-dvb-t2-sat-hevc-usb-3f6a6888-9b08-47e2-b303-f80dbcd1bbea?ocoi=R3pmU1JCcU9zWGhTWXREVXpRYzk2T1lYU3dQa3A4K2w%3D" data-role-type="product-fiche-link" data-onboarding-hook="product_fiche" rel="nofollow" target="_self" class="mp0t_0a m9qz_yp mp7g_oh mtsp_ib mli8_k4 mp4t_0 m3h2_0 mryx_0 munh_0 msbw_rf mldj_rf mtag_rf mm2b_rf mqvr_2 mqen_m6 m0qj_5r msts_n7 mh36_16 mvrt_16 mg9e_8 mj7a_8 mjir_sv m2ha_2 m8qd_vz mjt1_n2 m09p_40 bfwvy mgmw_u5g mrmn_qo mrhf_u8 m31c_kb m0ux_fp b14a0 mzmg_6m mjru_k4 mgn2_14 m6ax_n4 meqh_en msa3_z4 mjyo_6x m911_co mefy_co mnyp_co mdwl_co mx7m_1 mpof_ki m389_6m m7f5_6m _1e32a_jptRV">porównaj 2 oferty</a></div></div><div class="m911_co mpof_ki myre_zn m7f5_5x mg9e_8 mg9e_0_l mh36_16_l mx7m_1 mlkp_ag m7er_k4 _1e32a_WSqB7"><div class="mpof_ki"><div class="_1e32a_WGU9V mzaq_56"><div class="_1e32a_62rFQ"><div></div></div><div class="mj7a_4 mg9e_4 _1e32a_IAwmj"><div class="mpof_ki m389_0a mwdn_1"><div class="msa3_z4 m3h2_8"><span aria-label="437,70&nbsp;zł aktualna cena" tabindex="0"><span class="mli8_k4 msa3_z4 mqu1_1 mp0t_ji m9qz_yo mgmw_qw mgn2_27 mgn2_30_s">437,<span class="mgn2_19 mgn2_21_s m9qz_yq">70</span>&nbsp;<span class="mgn2_19 mgn2_21_s m9qz_yq">zł</span></span></span></div><span class="mpof_92 mp7g_oh"><div class="mp7g_oh "><div class="mgn2_12 mpof_ki m389_6m mwdn_1"><div class="mpof_ki m389_6m mwdn_1 _1e32a_x7RE- m3h2_0"><picture><source media="(prefers-color-scheme: dark)" srcset="https://a.allegroimg.com/original/34611c/c433ab0c4bf9a76e4f1f15b5dd1f/dark-brand-subbrand-smart-2ecf1fa38c.svg"><img src="https://a.allegroimg.com/original/343b4d/ed3f5c04412ab7bd70dd0a34f0cd/brand-subbrand-smart-d8bfa93f10.svg" alt="Smart!" class="mpof_z0 _1e32a_ELS6C"></picture></div></div><div class="mpof_5r mpof_3f_l "><div class="mjyo_6x mp7g_f6 mjb5_w6 msbw_2 mldj_2 mtag_2 mm2b_2 mgmw_wo msts_n6 m7er_k4 ti1554 ti1nw9 mpof_5r undefined"></div></div></div></span></div></div><div class="mqu1_g3 mgn2_12">darmowa dostawa</div></div><div class="mpof_ki myre_zn m389_0a mjyo_6x mvrt_4 _1e32a_LT2ZR"><div class="mh36_0"><div class="mzmg_f9"><img loading="lazy" src="https://assets.allegrostatic.com/seller-extras-2f/logotype_12241923_a7aa6ae0-2edb-46a7-813c-bdaa29b19eb0" alt="Firma" class="mp4t_0 m3h2_0 mryx_0 munh_0 msbw_2 mldj_2 mtag_2 mm2b_2 _1e32a_xI6uY"><span class="mgmw_3z mpof_z0 mgn2_12">Firma</span></div></div></div></div><div class="_1e32a_WGU9V mg9e_4"><div class="mgn2_12 mpof_ki m389_6m mwdn_1"><div class="mpof_ki m389_6m mwdn_1 m3h2_4 _1e32a_x7RE-" style="color: var(--m-color-text-secondary, #656565); font-weight: normal; text-decoration: none;"><span class="mli2_0">zapłać później z</span></div><div class="mpof_ki m389_6m mwdn_1 m3h2_4 _1e32a_x7RE-"><picture><source media="(prefers-color-scheme: dark)" srcset="https://a.allegroimg.com/original/1289e0/d44ff4a74fe8b73e619f76c756e8"><img src="https://a.allegroimg.com/original/1289e0/d44ff4a74fe8b73e619f76c756e8" alt="Allegro Pay" class="mpof_z0 _1e32a_ELS6C"></picture></div><div class="mpof_ki m389_6m mwdn_1 _1e32a_x7RE- m3h2_0"><span class="mli2_0" style="color: var(--m-color-text-secondary, #656565); font-weight: normal; text-decoration: none;">sprawdź</span></div></div><div><div class="mgn2_12"><div><span class="mgmw_3z _1e32a_XFNn4">Stan</span> <span class="mgmw_wo mvrt_8 ">Używany</span> </div></div></div><div class="mpof_ki m389_6m msa3_z4 mgn2_12">od <div class="mpof_ki mp7g_oh msa3_ae _1e32a_cwPPZ"><div class="mp7g_oh mpof_ki"><picture><source media="(prefers-color-scheme: dark)" srcset="https://a.allegroimg.com/original/34e1bf/82d1aebc4a9db9bef96345fd1e99/dark-information-common-super-seller-236577cfa7"><img src="https://a.allegroimg.com/original/34dd95/40d81c26458ca692070c8ed7eae5/information-common-super-seller-236577cfa7" alt="Super Sprzedawcy" class="m7er_56 _1e32a_97Mma "></picture><div class="mpof_5r mpof_3f_l "><div class="mjyo_6x mp7g_f6 mjb5_w6 msbw_2 mldj_2 mtag_2 mm2b_2 mgmw_wo msts_n6 m7er_k4 ti1554 ti1nw9 mpof_5r ti7yw2" style="top: -15px; left: 24px; width: 296px;"><div class="mg9e_16 mvrt_16 mh36_16 mgn2_14 mp0t_0a mqu1_21 mgmw_wo mli8_k4 mj7a_16 "><button type="button" class="mgn2_14 mp0t_0a m9qz_yp mtsp_ib mli8_k4 mp4t_0 m3h2_0 mryx_0 munh_0 m911_5r mefy_5r mnyp_5r mdwl_5r msbw_rf mldj_rf mtag_rf mm2b_rf mqvr_2 mqen_m6 meqh_en m0qj_5r msts_n7 mjir_sv m2ha_2 m8qd_vz mjt1_n2 m09p_40 bfwvy mgmw_u5g mrmn_qo mrhf_u8 m31c_kb m0ux_fp b14a0 mpof_5r_m mg9e_0 mvrt_0 mj7a_0 mh36_0 mp7g_f6 mnjl_0 mq1m_0"><img src="https://a.allegroimg.com/original/34f3f5/bf439aab49d0a78bcd7501d51697/action-common-x-6c70096572" alt="close" class="mjyo_6x meqh_en msa3_z4 mhd5_0m i150e"></button><div class="mgn2_14 mp0t_0a mqu1_21 mgmw_wo mli8_k4 mvrt_24 mvrt_0_m">Tym symbolem wyróżniamy najlepsze sklepy w Allegro. Gdy kupujesz od Super Sprzedawcy, masz pewność doskonałej obsługi klienta i udanych zakupów.</div></div></div></div></div></div> Super Sprzedawcy</div><div class="mgn2_12 mpof_ki m389_6m mwdn_1"><div class="mpof_ki m389_6m mwdn_1 _1e32a_x7RE- m3h2_0"><span class="mli2_0" style="color: rgb(27, 184, 40); font-weight: bold; text-decoration: none;">dostawa we&nbsp;wtorek</span><div class="mp7g_oh "><picture><source media="(prefers-color-scheme: dark)" srcset="https://assets.allegrostatic.com/fast-delivery-icons/information-dark.svg"><img src="https://assets.allegrostatic.com/fast-delivery-icons/information.svg" alt="" class="mpof_z0 _1e32a_ELS6C"></picture><div class="mpof_5r mpof_3f_l mpof_3f"><div class="mjyo_6x mp7g_f6 mjb5_w6 msbw_2 mldj_2 mtag_2 mm2b_2 mgmw_wo msts_n6 m7er_k4 ti1554 ti1nw9 mpof_5r undefined"></div></div></div></div></div></div><div class="mpof_ki m7f5_0a mjyo_6x mzaq_1 mr3m_0 mp4t_56 mg9e_16 mvrt_4 mzmg_6m m7er_k4"><button data-role-type="add-to-cart-button" class="mgn2_14 mp0t_0a m9qz_yp mp7g_oh mtsp_ib mli8_k4 mp4t_0 mryx_0 munh_0 m911_5r mefy_5r mnyp_5r mdwl_5r msbw_rf mldj_rf mtag_rf mm2b_rf mqvr_2 mqen_m6 meqh_en m0qj_5r mh36_16 mvrt_16 mg9e_8 mj7a_8 mjir_sv m2ha_2 m8qd_vz mjt1_n2 m09p_40 bfwvy mgmw_yu msts_er mrmn_qo mrhf_u8 m31c_kb m0ux_fp b14ge mzaq_1 mzmg_6m m7er_k4 m3h2_8"><span>dodaj do koszyka</span></button><button aria-label="Dodaj do ulubionych" class="m7er_40 mp0t_0a m9qz_yp mp7g_oh mtsp_ib mli8_k4 mp4t_0 m3h2_0 mryx_0 munh_0 m911_5r mefy_5r mnyp_5r mdwl_5r msbw_rf mldj_rf mtag_rf mm2b_rf mqvr_2 mqen_m6 meqh_en m0qj_5r msts_n7 mjir_sv m2ha_2 m8qd_vz mjt1_n2 m09p_40 bfwvy mgmw_u5g mrmn_qo mrhf_u8 m31c_kb m0ux_fp b14a0 mqu1_1 mgn2_13 mg9e_0 mvrt_0 mj7a_0 mh36_0 mse2_40"><picture><source media="(prefers-color-scheme: dark)" srcset="https://a.allegroimg.com/original/34da48/7daf74174cbab949125433930aba/dark-action-common-heart-d21a0d364b"><img src="https://a.allegroimg.com/original/342704/5df50ccf415c9dc190264897d100/action-common-heart-322d64f02b" alt="" aria-hidden="true" class="mjyo_6x meqh_en msa3_z4 mhd5_0m i150e mse2_40 mg9e_4 mvrt_4 mj7a_4 mh36_4 m0s5_ki"></picture></button></div></div></div></div>"""
            "437,70 PLN"
        ),
    ],
)
def test_find_price(scraper, html_input, expected_price):
    """
    Test the find_price function from GeneralizedScraper.
    """
    soup = BeautifulSoup(html_input, "html.parser")
    block = soup.div  # Assume we're testing the <div> block

    # Call the find_price function
    detected_price = scraper.find_price(block)

    # Assert the output matches the expected price
    assert detected_price == expected_price
